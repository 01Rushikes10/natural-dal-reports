name: Daily Natural Dal Report

on:
  schedule:
    # Runs at 6:00 PM IST daily (12:30 PM UTC)
    - cron: '30 12 * * *'
  workflow_dispatch:

jobs:
  send-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check URL Accessibility
      run: |
        REPORT_URL="https://naturaldal1.kesug.com/wp-content/plugins/natural-dal-reports/send_daily_report.php?force=yes&source=github"
        
        echo "Testing URL: $REPORT_URL"
        
        # Test 1: Check if domain resolves
        echo "1. Testing DNS resolution..."
        if ping -c 1 naturaldal1.kesug.com &> /dev/null; then
          echo "✅ DNS resolution successful"
        else
          echo "❌ DNS resolution failed"
        fi
        
        # Test 2: Check if port 443 is open
        echo "2. Testing port 443..."
        if nc -z -w 5 naturaldal1.kesug.com 443; then
          echo "✅ Port 443 is open"
        else
          echo "❌ Port 443 is closed"
        fi
        
        # Test 3: Make detailed HTTP request
        echo "3. Making HTTP request with verbose output..."
        curl -v --max-time 30 "$REPORT_URL" || echo "CURL failed with exit code: $?"
        
    - name: Trigger Daily Report
      run: |
        REPORT_URL="https://naturaldal1.kesug.com/wp-content/plugins/natural-dal-reports/send_daily_report.php?force=yes&source=github"
        
        echo "Making final request..."
        response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" --max-time 30 "$REPORT_URL")
        
        # Extract HTTP status
        http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d':' -f2)
        body=$(echo "$response" | grep -v "HTTP_STATUS:")
        
        echo "Response Body: $body"
        echo "HTTP Status: $http_status"
        
        if [[ "$http_status" == "200" ]]; then
          echo "✅ Report triggered successfully"
        else
          echo "❌ Report trigger failed with HTTP $http_status"
        fi
    
    - name: Log Completion
      run: |
        echo "::notice ::Daily report execution completed at $(date)"
